---
title: "cwim èƒŒåçš„æ•…äº‹ï¼šRust ä¸ Ownership"
date: 2020-01-23
published: true
slug: cli-app-in-rust
tags: ['Tech', 'Rust', 'CLI']
cover_image: ./images/cli-app-in-rust.png
canonical_url: false
description: "Rust æ˜¯å¦‚ä½•ä¿è¯ã€Œå†…å­˜å®‰å…¨ã€çš„"
---

å‰å‡ å¤© Stack Overflow åšå®¢ä¸Šé¢æœ‰ä¸€ç¯‡æ–‡ç« [^1]ï¼Œé‡Œé¢æåˆ°äº† Rust å·²ç»è¿ç»­å››å¹´ä½åˆ— Stack Overflow ç¤¾åŒºæœ€çˆ±ç¼–ç¨‹è¯­è¨€æ¦œé¦–ã€‚çš„ç¡®ï¼ŒRust æ˜¯ä¸€é—¨ç¥å¥‡åˆç¾ä¸½çš„è¯­è¨€ã€‚Rust æ˜¯ä¸€é—¨æ ‡æ¦œ safe ä¸ zero-cost abstraction çš„è¯­è¨€[^2]ï¼Œæ„å‘³ç€åªè¦ä½ ç¼–å†™çš„ Rust ä»£ç ç¬¦åˆå®˜æ–¹æ ‡å‡† â€”â€” èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘ â€”â€” é‚£ä¹ˆä½ çš„é¡¹ç›®å‡ ä¹å¯ä»¥è‚¯å®šåœ°è¯´æ˜¯å†…å­˜å®‰å…¨çš„ã€‚

## åˆè¡·

åå‘åº•å±‚çš„ Rust è®©æˆ‘åœ¨ä¹‹å‰ä¸€ç›´æ²¡æœ‰æœºä¼šå°è¯•ï¼Œæ¯•ç«Ÿæˆ‘ç›¸ä¿¡å›½å†…é«˜æ ¡æ²¡æœ‰ä¸€æ‰€æ˜¯æ•¢ç›´æ¥æŠ›å¼ƒ Cã€C++ è€Œä½¿ç”¨ Rust ä½œä¸ºå…¶ä¸»è¯­è¨€è¿›è¡Œæˆè¯¾çš„ã€‚æœ€è¿‘æˆ‘é‡æ„äº† [Dev on Windows with WSL](https://dowww.spencerwoo.com)ï¼šä¸€ä¸ªè¿‘ 2w å­—çš„ WSL å¼€å‘é…ç½®æ–‡æ¡£ã€‚æˆ‘å‰åç”¨äº†å¤§æ¦‚åŠä¸ªæœˆçš„æ—¶é—´ï¼Œå¢åŠ äº†è®¸å¤šå†…å®¹ï¼Œå› æ­¤æˆ‘åœ¨ç»“æŸç¼–å†™å·¥ä½œä¹‹åï¼Œè¯•å›¾æ‰¾åˆ°ä¸€ä¸ªç±»ä¼¼ `cloc`ï¼Œèƒ½å¸®æˆ‘ç»Ÿè®¡ä¸€ä¸ªç›®å½•ä¸‹å…¨éƒ¨ Markdown æ–‡ä»¶çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å¾ˆå¤±æœ›ï¼Œæ²¡æ‰¾åˆ°ã€‚

æˆ‘å†³å®šè‡ªå·±å°è¯•å®ç°è¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå½“ç„¶ï¼Œæˆ‘ä¹Ÿç›¸ä¿¡ Pythonã€Node.jsã€Ruby ç­‰è„šæœ¬è¯­è¨€ä¸€å®šé€‚åˆåšè¿™äº›äº‹æƒ…ï¼Œæ¯•ç«Ÿ `cloc` æœ¬èº«å°±æ˜¯ä½¿ç”¨ Perl å®ç°çš„ã€‚ä¸è¿‡ï¼ŒRust ä½œä¸ºä¸€é—¨é«˜æ•ˆçš„ã€é™æ€çš„ã€å¯ä»¥ç›´æ¥ç¼–è¯‘åˆ°ä¸‰ä¸ªæ“ä½œç³»ç»Ÿçš„åº•å±‚è¯­è¨€ï¼Œè¿˜æ˜¯å¾ˆæœ‰å¸å¼•åŠ›çš„ã€‚å› æ­¤æˆ‘æ‰å†³å®šä½¿ç”¨ Rust å¼€æ–°å‘ã€‚

![ä½¿ç”¨ Rust å®ç°çš„ cwim - Count words in Markdown](https://i.loli.net/2020/01/23/g1q5amsOedyE7op.png)

å¦å¤–ï¼šcwim çš„ç¬¬ä¸€ä¸ªå°ç‰ˆæœ¬æˆ‘å·²ç»ç¼–è¯‘å¹¶å‘å¸ƒ Release ç‰ˆæœ¬ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‰å¾€ GitHub æŸ¥çœ‹ï¼š[spencerwooo/cwim](https://github.com/spencerwooo/cwim).

## å¼€å§‹ä¸€ä¸ª Rust é¡¹ç›®

Rust æœ€ beginner friendly çš„åœ°æ–¹æˆ‘è§‰å¾—åœ¨äºå…¶[å®˜æ–¹å…¥é—¨æ–‡æ¡£](https://www.rust-lang.org/zh-CN/learn/get-started)çš„ç®€æ´æ˜“æ‡‚ã€‚ä»å®‰è£…ã€ç¼–è¯‘åˆ°åŒ…ç®¡ç†ã€æ‰“åŒ…é¡¹ç›® â€¦â€¦ Rust çš„å®˜æ–¹æ–‡æ¡£è®²è§£çš„éƒ½æ¯”ä»»ä½•å…¶ä»–è¯­è¨€çš„æ–‡æ¡£è®²è§£çš„è¦æ˜“æ‡‚ä¸å°‘ã€‚æˆ‘è¿™é‡Œç®€å•è®°å½•ä¸€ä¸‹ Rust ç¯å¢ƒçš„å®‰è£…æ­å»ºçš„åŸºæœ¬è¿‡ç¨‹ã€‚

### å®‰è£… Rust ç¯å¢ƒ

Rust è¯­è¨€è™½ç„¶å°ä¼—ï¼Œä½†æ˜¯å…¶ç”Ÿæ€ç›¸å½“å®Œå–„ã€‚Rust å€Ÿé‰´äº†å…¶ä»–è¯­è¨€çš„å¤šç§ç¯å¢ƒé…ç½®å·¥å…·ï¼Œå®˜æ–¹ç›´æ¥æä¾›äº†ä¸€æ•´å¥—å®Œå–„çš„é—­ç¯ Toolkitï¼ŒåŸºæœ¬èƒ½æ»¡è¶³æˆ‘ä»¬åœ¨ä½¿ç”¨ Rust æ—¶çš„å®‰è£…ã€æ„å»ºã€ç¼–è¯‘ã€å‘å¸ƒçš„æ•´å¥—æµç¨‹ï¼š

- Rustupï¼šRust ç‰ˆæœ¬ç®¡ç†ï¼ˆç±»ä¼¼ Python çš„ `pyenv`ã€Node.js çš„ `nvm` ç­‰ï¼‰
- Cargoï¼šRust æ„å»ºå·¥å…·ä¸åŒ…ç®¡ç†ï¼ˆç±»ä¼¼ Python çš„ `pip`ã€Node.js çš„ `yarn` ç­‰ï¼‰
- crates.ioï¼šRust çš„ Package Registry

é¦–å…ˆï¼Œæˆ‘ä»¬å®‰è£… Rustupï¼šRust å®‰è£…å™¨ä¸ Rust ç‰ˆæœ¬æ§åˆ¶å™¨ã€‚ä½¿ç”¨ Arch Linuxï¼ˆä»¥åŠ WSL çš„ Arch Linuxï¼‰çš„åŒå­¦å¯ä»¥ç›´æ¥åœ¨ AUR ä¸­å®‰è£… `rustup`ï¼š

```bash
yay rustup
```

å¦‚æœä½¿ç”¨ WSL å…¶ä»– Linux å‘è¡Œç‰ˆï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… `rustup`ï¼š

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

å…¶ä»–å®‰è£…æ–¹æ³•è¯·å‚è€ƒï¼š[Rust | å®‰è£… Rust](https://www.rust-lang.org/zh-CN/tools/install)

å®‰è£…äº† `rustup` ä¹‹åï¼Œæˆ‘ä»¬å°±åº”è¯¥å·²ç»å®‰è£…å®Œæˆäº† Cargoï¼šRust çš„æ„å»ºå·¥å…·ä¸åŒ…ç®¡ç†å·¥å…·ã€‚Cargo å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼š

```bash
cargo build     # å¯ä»¥æ„å»ºé¡¹ç›®
cargo run       # å¯ä»¥è¿è¡Œé¡¹ç›®
cargo test      # å¯ä»¥æµ‹è¯•é¡¹ç›®
cargo doc       # å¯ä»¥ä¸ºé¡¹ç›®æ„å»ºæ–‡æ¡£
cargo publish   # å¯ä»¥å°†åº“å‘å¸ƒåˆ° crates.io
```

è¦æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Rust å’Œ Cargoï¼Œå¯ä»¥åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š

```bash
cargo --version
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Cargo æ¥åˆ›å»ºä¸€ä¸ª Rust é¡¹ç›®ï¼Œå¹¶ç”¨å®ƒæ¥å®‰è£…æˆ‘ä»¬å¿…é¡»çš„ Rust åº“ç­‰å†…å®¹ã€‚

### Rust / VS Code

VS Code æ˜¯ä¸€ä¸ªé€šç”¨çš„æ–‡æœ¬ / ä»£ç ç¼–è¾‘å™¨ï¼Œèƒ½å¤Ÿé€šè¿‡æ’ä»¶æ”¯æŒå¤šç§è¯­è¨€ç¯å¢ƒä¸‹ä»£ç çš„ç¼–å†™ä»»åŠ¡ã€‚æˆ‘ä»¬ä¸‹è½½ Rust å®˜æ–¹æä¾›çš„ VS Code æ’ä»¶ï¼š[Visual Studio Code Marketplace | Rust (rls)](https://marketplace.visualstudio.com/items?itemName=rust-lang.rust)

![Visual Studio Code Marketplace | Rust (rls)](https://i.loli.net/2020/01/24/QR4GTfrbq2DCHK8.png)

ä¹‹åï¼Œæˆ‘ä»¬ç”¨ Cargo åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›® `hello-rust`ï¼š

```bash
cargo new hello-rust
```

æˆ–è€…åœ¨å·²æœ‰æ–‡ä»¶å¤¹ `hello-rust` ä¸‹ï¼Œç”Ÿæˆæ–° Rust é¡¹ç›®ï¼š

```bash
cd hello-rust
cargo init
```

æ–°çš„ Rust é¡¹ç›®ç›®å½•ä¸‹åº”è¯¥æ‹¥æœ‰ä»¥ä¸‹å†…å®¹ï¼š

```bash
hello-rust      # æ ¹ç›®å½•
|- Cargo.toml   # Rust çš„æ¸…å•æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«é¡¹ç›®çš„å…ƒæ•°æ®å’Œä¾èµ–åº“
|- src
  |- main.rs    # ä¸»ç¨‹åºå…¥å£
```

ç”¨ VS Code æ‰“å¼€è¿™ä¸€ç›®å½•ï¼Œæˆ‘ä»¬å³å¯å¼€å§‹ Rust é¡¹ç›®çš„ç¼–å†™ã€‚

![ä½¿ç”¨ VS Code æ’°å†™ Rust é¡¹ç›®](https://i.loli.net/2020/01/24/3gZDyvY95UHAtiC.png)

ä½¿ç”¨ä¸‹é¢å‘½ä»¤å³å¯è¿è¡Œé¡¹ç›®ï¼š

```bash
cargo run
```

## Rust è¯­è¨€ç‰¹æ€§

åœ¨ç”¨ Rust ç¼–å†™ `cwim` çš„æ—¶å€™ï¼Œæœ‰ä¸¤ä¸ªä»¤æˆ‘å°è±¡æ·±åˆ»çš„åœ°æ–¹ï¼šä¸€ä¸ªæ˜¯ Rust è¯­è¨€å®é™…ä¸Šéå¸¸æ¸…æ™°æ˜“æ‡‚ï¼Œæœ‰ Cã€C++ ç­‰å¼ºç±»å‹è¯­è¨€çš„ä¸¥è°¨ï¼Œä¹Ÿæœ‰è„šæœ¬è¯­è¨€çš„æ˜“è¯»ï¼›å¦ä¸€ä¸ªå°±æ˜¯ Rust ç¼–è¯‘å™¨éå¸¸ä¸¥æ ¼ï¼Œä½†ç»™æˆ‘ä»¬çš„é—®é¢˜æç¤ºä¹Ÿéå¸¸æ¸…æ™°ï¼Œæ–¹ä¾¿è¿½æº¯é—®é¢˜æ‰€åœ¨ï¼Œå®¹æ˜“ debugã€‚ä¸¥è‹›çš„ Rust ç¼–è¯‘å™¨è®©æˆ‘ä»¬å¿…é¡»è€ƒè™‘ã€Œå†…å­˜åˆ†é…ã€ï¼Œä¹Ÿæ­£å› å¦‚æ­¤ï¼Œä½¿å¾— **Rust åœ¨å¹¶æœªå®ç°ã€Œåƒåœ¾å›æ”¶ã€çš„å‰æä¸‹ï¼Œç¡®ä¿äº†ä»»ä½• Rust ç¨‹åºéƒ½ç”Ÿæ¥å…·æœ‰ã€Œå†…å­˜å®‰å…¨ã€ç‰¹æ€§ã€‚**

> ğŸ§² **Rust Playground**
>
> ä¸‹é¢æ¶‰åŠåˆ°çš„ä»£ç å†…å®¹å¯ä»¥åœ¨ Rust åœ¨çº¿ Playground ä¸­è‡ªå·±å°è¯•ã€‚é“¾æ¥ä½äºï¼š[Rust Playground](https://play.rust-lang.org)

### Ownership

Rust çš„ Ownershipï¼ˆæ‰€æœ‰æƒï¼‰æ˜¯ä¿è¯ Rust ç¨‹åºã€Œå†…å­˜å®‰å…¨ã€çš„é‡ç‚¹ç‰¹æ€§ã€‚ä»€ä¹ˆæ˜¯ã€Œå†…å­˜å®‰å…¨ã€ï¼Ÿä¿è¯ã€Œå†…å­˜å®‰å…¨ã€å°±æ˜¯æŒ‡æˆ–è¯­è¨€æœ¬èº«ï¼Œæˆ–ä½¿ç”¨è¯­è¨€çš„å¼€å‘è€…ï¼Œåœ¨å…¶ç¨‹åºè¿è¡Œæ—¶ç®¡ç†ç³»ç»Ÿçš„ã€Œå†…å­˜åˆ†é…ã€çš„è¿‡ç¨‹ä¸­ä¿è¯å†…å­˜æ²¡æœ‰æµªè´¹ã€æ²¡æœ‰æ³„éœ²ã€‚æˆ‘ä»¬ä¸€èˆ¬çš„ç¨‹åºéƒ½éœ€è¦å®æ–½ã€Œé™æ€ã€ä¸ã€ŒåŠ¨æ€ã€ä¸¤ç§å½¢å¼çš„å†…å­˜åˆ†é…ï¼Œå…¶ä¸­å‰è€…æŒ‡å·²çŸ¥å˜é‡æ‰€éœ€ç©ºé—´ï¼Œç›´æ¥åœ¨å†…å­˜ä¸­åˆ’åˆ†ä¸€éƒ¨åˆ†ä¸å˜çš„åŒºåŸŸç»™å˜é‡ï¼›åè€…ä¸ºåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€åœ°ç»™å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œä½¿å¾—å˜é‡èƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡Œæ—¶å˜åŒ–åœ°å ç”¨å†…å­˜å¤§å°ã€‚

### æ•°æ®å­˜å‚¨æ–¹å¼

Rust æ˜¯ä½¿ç”¨ã€Œæ ˆã€å’Œã€Œå †ã€è¿™ä¸¤ç§æ•°æ®ç»“æ„æ¥å¯¹è¿™ä¸¤ç§å†…å­˜åˆ†é…å½¢å¼è¿›è¡Œåˆ’åˆ†çš„ã€‚ä¸ºäº†æ›´å¥½çš„ç†è§£ Rust çš„ Ownership çš„å·¥ä½œæœºåˆ¶ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹çœ‹ Rust æ˜¯å¦‚ä½•åˆ©ç”¨ã€Œæ ˆã€å’Œã€Œå †ã€è¿›è¡Œå†…å­˜åˆ†é…ã€‚

![ä½¿ç”¨ã€Œæ ˆã€å’Œã€Œå †ã€è¿›è¡Œå†…å­˜åˆ†é…](https://i.loli.net/2020/01/25/qb3QyEH4euULclY.png)

é¦–å…ˆï¼Œã€Œæ ˆã€ä»å®ç°ä¸Šæ¥è¯´æ˜¯ä¸€ç§æ•ˆç‡éå¸¸é«˜çš„æ•°æ®ç»“æ„ï¼Œå› ä¸ºã€Œæ ˆã€æ‹¥æœ‰ã€Œåè¿›å…ˆå‡ºã€çš„æ•°æ®å­˜å‚¨ç‰¹ç‚¹ï¼ˆLIFOï¼‰ï¼Œä½¿å¾—æœ€åå‹å…¥æ ˆé¡¶çš„å…ƒç´ ä¼šè¢«æœ€å…ˆä»æ ˆé¡¶ç§»å‡ºã€‚è¿™ç§æ•°æ®ç»“æ„çš„ä¼˜åŠ¿åœ¨äºï¼šå½“æˆ‘ä»¬ç”¨ã€Œæ ˆã€æ¥ç»´æŠ¤å†…å­˜æ•°æ®æ—¶ï¼Œ**æˆ‘ä»¬åªéœ€è¦ç»´æŠ¤ã€Œæ ˆé¡¶ã€å…ƒç´ çš„ä¿¡æ¯å³å¯**ã€‚åŒæ—¶ï¼ŒRust å†…å­˜ç®¡ç†çš„ã€Œæ ˆã€åœ¨ç¼–è¯‘æ—¶å³å¯çŸ¥é“å…¶å…·ä½“å¤§å°ï¼Œé™æ€åˆ†é…å†…å­˜ç©ºé—´å³å¯[^3]ã€‚

è€Œ Rust çš„ã€Œå †ã€åˆ™ä¸ä¸€æ ·ï¼Œã€Œå †ã€æ˜¯ä¸€ä¸ªåŠ¨æ€åˆ†é…å†…å­˜ç©ºé—´çš„æ•°æ®ç»“æ„ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ã€Œå †ã€åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨ã€Œå †ã€ä¸Šå¯»æ‰¾å¯¹åº”çš„å†…å­˜åœ°å€ï¼Œå°†ä¹‹æ ‡è®°ï¼Œå¹¶è¿”å›ä¸ä¹‹ç›¸å¯¹æ˜ çš„æŒ‡é’ˆã€‚è¿™ä¸€è¿‡ç¨‹è·Ÿæˆ‘ä»¬ Cã€C++ ä¸­çš„ allocate memory çš„åŸç†æ˜¯ä¸€è‡´çš„ã€‚

### æ‰€æœ‰æƒå¦‚ä½•ä¿è¯å†…å­˜å®‰å…¨

ä¸ºä»€ä¹ˆ Rust éœ€è¦å¼•å…¥ã€Œæ‰€æœ‰æƒã€çš„æœºåˆ¶ï¼Ÿå› ä¸º Rust ä¿è¯ã€Œå†…å­˜å®‰å…¨ã€çš„æ–¹æ³•æ˜¯ï¼šè¿½è¸ªç¬¬äºŒç§ã€Œå †ã€ç»“æ„ä¸­å“ªéƒ¨åˆ†æ•°æ®è¢«å“ªéƒ¨åˆ†ä»£ç ä½¿ç”¨ï¼Œä»è€Œå°½é‡å‡å°‘ã€Œå †ã€ä¸­çš„é‡å¤æ•°æ®ï¼Œä¿è¯ã€Œå †ã€ä¸­ä¸å‡ºç°æœ‰æœªä½¿ç”¨çš„æ•°æ®ç­‰é—®é¢˜ã€‚

> Keeping track of what parts of code are using what data on the heap, minimizing the amount of duplicate data on the heap, and cleaning up unused data on the heap so you donâ€™t run out of space are all problems that ownership addresses. â€”â€” [The Rust Book](https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html)

Rust æ­£æ˜¯ä½¿ç”¨åŸºäºã€Œæ‰€æœ‰æƒã€ç†å¿µçš„ä¸€ç³»åˆ—è§„å®šæ¥ä¿è¯ Rust ç¨‹åºçš„ã€Œå†…å­˜å®‰å…¨ã€ã€‚è¿™å…¶ä¸­çš„æœºåˆ¶åŒ…æ‹¬ï¼š

- Rust ä¸­çš„æ¯ä¸ªã€Œå€¼ã€éƒ½æœ‰ä¸€ä¸ªè¢«å«åš owner çš„å˜é‡ï¼ˆæ‰€æœ‰è€…ï¼‰
- åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª owner
- å½“ owner ç¦»å¼€æˆ‘ä»¬ç¨‹åºæ®µçš„ scope ä¹‹åï¼Œè¿™ä¸€ã€Œå€¼ã€å°±ä¼šè¢«é‡Šæ”¾æ‰

æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„å‡ ä¸ªä¾‹å­ï¼Œæ¥å…·ä½“çœ‹çœ‹ Rust å¦‚ä½•ä¿è¯ã€Œå†…å­˜å®‰å…¨ã€çš„ã€‚

æˆ‘ä»¬ä»¥ Rust ä¸­å­—ç¬¦ä¸²ï¼ˆString Literalï¼‰ä¸ºä¾‹å­ï¼ŒRust ä¸­å­—ç¬¦ä¸²æœ‰ `&str` çš„é™æ€å­—ç¬¦ä¸²å˜é‡ï¼Œä»¥åŠ `String` çš„åŠ¨æ€å­—ç¬¦ä¸²å˜é‡ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ Rust æ˜¯å¦‚ä½•åˆ†åˆ«åˆ©ç”¨ã€Œæ ˆã€æ¥å­˜å‚¨ `&str`ã€ç”¨ã€Œå †ã€æ¥å­˜å‚¨ `String` çš„ã€‚

é¦–å…ˆæ¥çœ‹ä¸€ä¸ª `&str` çš„ä¾‹å­ï¼š

```rust
fn main() {
  // &str ç”¨ã€Œæ ˆã€å­˜å‚¨
  let s1 = "Hello";    // å­—ç¬¦ä¸² "Hello" èµ‹å€¼ç»™å˜é‡ s1
  let s2 = s1;         // å°†å˜é‡ s1 å¤åˆ¶å¹¶èµ‹å€¼ç»™ s2
  println!("{}", s1);  // è¿™æ ·åšæ²¡æœ‰é—®é¢˜ï¼
}
```

å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `&str` å­˜å‚¨å­—ç¬¦ä¸²æ—¶ï¼ŒRust æ˜¯å°†å‰ä¸€ä¸ªå˜é‡ `s1` çš„å€¼**ç›´æ¥å¤åˆ¶**ç»™åä¸€ä¸ªå˜é‡ `s2`ï¼Œå‰ä¸€ä¸ªå˜é‡ `s1` å¹¶æ²¡æœ‰å˜åŒ–ã€‚æ­¤æ—¶æˆ‘ä»¬è®¿é—®å‰ä¸€ä¸ªå˜é‡ `s1` æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª `String` çš„ä¾‹å­ï¼š

```rust
fn main() {
  // String ç”¨ã€Œå †ã€å­˜å‚¨
  let s1 = String::from("Hello again"); // String å˜é‡ "Hello again" èµ‹å€¼ç»™ s1
  let s2 = foo;                         // å°† s1 å˜é‡ä¸­çš„å†…å®¹ã€Œç§»åŠ¨ã€åˆ° s2 ä¸­
  println!("{}, {}", s1, s2);           // å‡ºé”™äº†ï¼s1 ä¸­å†…å®¹è¢« movedï¼Œæ— æ³•è¢« reference
}
```

æ­¤æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥å‡º `error[E0382]: borrow of moved value: 's1'` çš„é”™è¯¯ã€‚å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ String å­˜å‚¨å­—ç¬¦ä¸²æ—¶ï¼ŒRust ä¸ä¼šå°†å˜é‡çš„å€¼ã€Œå¤åˆ¶ã€ï¼Œè€Œæ˜¯ä¼šå°†å˜é‡ã€Œç§»åŠ¨ã€åˆ°ç›®æ ‡å˜é‡ä¸­ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒRust ä¼šè®¤ä¸ºå‰ä¸€ä¸ªå˜é‡ `s1` å·²ç»ä¸å†æœ‰æ•ˆï¼ˆno longer validï¼‰ï¼Œå› æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨ä¹‹åè¯•å›¾è®¿é—® `s1` æ—¶ï¼ŒRust å°±ä¼šæŠ¥å‡ºè¿™ä¸€é”™è¯¯ã€‚

![error[E0382] æŠ¥é”™](https://i.loli.net/2020/01/25/VJ943b2TDswRB7N.png)

ä¸ºä»€ä¹ˆ Rust åœ¨ä½¿ç”¨ã€Œå †ã€è¿›è¡ŒåŠ¨æ€å†…å­˜åˆ†é…æ—¶ï¼Œä¼š move è€Œä¸ copy å‘¢ï¼Ÿä¸€æ–¹é¢æ˜¯å› ä¸º copy çš„æ¶ˆè€—æ˜¯æ¯” move å¤§å¾—å¤šçš„ï¼›å¦ä¸€æ–¹é¢ï¼ŒRust è¿™ä¸€è®¾è®¡æ°å¥½å¸®åŠ©æˆ‘ä»¬é¿å…äº† C è¯­è¨€ä¸­éå¸¸å¯èƒ½é‡åˆ°çš„ä¸€ç§å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼š**double free å¼‚å¸¸**[^4]ã€‚

Double free å¼‚å¸¸æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿå½“æˆ‘ä»¬ä½¿ç”¨ `String` ç±»å‹æ¥å­˜å‚¨å­—ç¬¦ä¸²æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šå­˜å‚¨äº†ä»¥ä¸‹ä¸‰ä¸ª field çš„å€¼ï¼š`ptr`ã€`len`ã€`capacity`ã€‚`ptr` æŒ‡å‘å­˜å‚¨å­—ç¬¦ä¸²å†…å®¹çš„å†…å­˜ç©ºé—´ã€‚æ¯”å¦‚ `let s1 = String::from("Hello");` å³å£°æ˜äº†å¦‚ä¸‹çš„å­˜å‚¨æ–¹å¼ï¼š

![String çš„å­˜å‚¨æ–¹å¼](https://i.loli.net/2020/01/25/7iJ18PQdtqfUcNz.png)

æˆ‘ä»¬å¦‚æœä½¿ç”¨ `copy` å°† String `s1` å¤åˆ¶ç»™ `s2`ï¼Œæˆ‘ä»¬å®é™…ä¸Šå°±å°†ä¸‰ä¸ª field çš„å€¼ `ptr`ã€`len` å’Œ `capacity` å…¨éƒ¨å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ `ptr` æŒ‡é’ˆå®é™…ä¸ŠæŒ‡å‘ä¸Šä¸€å—åœ°å€ç©ºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ä½¿ç”¨ copy å°† s1 å¤åˆ¶ç»™ s2](https://i.loli.net/2020/01/25/RKb2kyXjLS87VFT.png)

å‰é¢æˆ‘ä»¬æåˆ°äº†ï¼Œ_å¯¹äºä¸€ä¸ªã€Œå€¼ã€æ¥è¯´ï¼Œå½“ç¨‹åºç¦»å¼€ã€Œå€¼ã€çš„ owner æ‰€åœ¨çš„ scope ä¹‹åï¼Œè¿™ä¸€ã€Œå€¼ã€å°±ä¼šè¢«é‡Šæ”¾æ‰_ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ç¦»å¼€ `s1` å’Œ `s2` æ‰€åœ¨çš„ scope ä¹‹åï¼Œç¨‹åºåˆ™ä¼šè¯•å›¾å°†è¿™ä¸¤ä¸ªã€Œå€¼ã€çš„å†…å­˜ç©ºé—´å…¨éƒ¨é‡Šæ”¾ï¼Œè€Œæ­¤æ—¶ `s1` å’Œ `s2` æŒ‡å‘åŒä¸€å—åœ°å€ç©ºé—´ï¼Œ**è¿™ç§æƒ…å†µä¸‹å°±ä¼šå‡ºç° double free å¼‚å¸¸çš„æƒ…å†µ**ã€‚

> Freeing memory twice can lead to memory corruption, which can potentially lead to security vulnerabilities.

è€Œæˆ‘ä»¬ Rust å°±é€šè¿‡ã€Œæ‰€æœ‰æƒã€è§„é¿äº†è¿™ä¸€é—®é¢˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒRust åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šæ˜¯å°† `s1` çš„å€¼ç§»åŠ¨åˆ°äº† `s2` ä¸Šï¼Œåœ¨ `s2` çš„æŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„å†…å­˜ç©ºé—´æ—¶ï¼ŒRust ä¼šè®¤ä¸º `s1` æ­¤æ—¶å·²ç»æ— ç”¨äº†ï¼Œä»è€Œç›´æ¥ invalidate æ‰ `s1`ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ç¨‹åºç¦»å¼€å½“å‰ scope åï¼Œvalid çš„ã€Œå€¼ã€åªæœ‰ `s2`ï¼ŒRust å°±åªä¼šå°† `s2` é‡Šæ”¾ï¼Œä»è€Œé¿å…å‡ºç° double free å¼‚å¸¸çš„æƒ…å†µã€‚

![Rust ä¸­ s1 move ç»™ s2 ä¹‹åï¼Œs1 è¢«è®¤ä¸º invalid](https://i.loli.net/2020/01/25/n6DWijACRFa43Bw.png)

ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬æ­¤æ—¶ä¸€å®šè¦è®¿é—® `s1` çš„å†…å®¹æ€ä¹ˆåŠï¼ŸRust æœ‰ä¸€ä¸ªä¸“é—¨çš„æ–¹æ³•ï¼Œè®© `s2` åˆ›å»ºæ—¶ï¼Œä¸ move è€Œæ˜¯æ·±åº¦æ‹·è´ `s1` çš„å…¨éƒ¨å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Rust ä¸­å°† s1 deep copy ç»™ s2](https://i.loli.net/2020/01/25/XxrfdiQBzt4MNFY.png)

è¿™é‡Œ Rust æ‰€åšçš„äº‹æƒ…ç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„ deep copy â€”â€” èŠ±è´¹æ›´å¤§çš„å¼€é”€ï¼Œå°† `s1` å­—ç¬¦ä¸²å¯¹åº”çš„ã€Œå †ã€å¤åˆ¶ä¸€ä¸ªï¼Œå†åˆ†é…å†…å­˜ç©ºé—´å­˜å‚¨å¤åˆ¶å‡ºæ¥çš„ `s1` å¹¶å°†ä¹‹èµ‹ç»™ `s2`ã€‚åœ¨ Rust ä¸­æˆ‘ä»¬å¯ä»¥ç”¨ `<VARIABLE>.clone()` æ¥è¡¨ç¤ºè¿™ä¸€åŠŸèƒ½ï¼š

```rust
fn main() {
  let s1 = String::from("hello");
  let s2 = s1.clone();

  println!("s1 = {}, s2 = {}", s1, s2);
}
```

ä¸Šé¢çš„ä»£ç å°±ä¸ä¼šå‡ºç°ç±»ä¼¼çš„é”™è¯¯äº†ã€‚Rust è¯­è¨€**å¯¹ã€ŒåŠ¨æ€ã€æ•°æ®ç»“æ„**éƒ½æœ‰ç±»ä¼¼çš„åŠŸèƒ½å®‰æ’ï¼šåˆ©ç”¨ Ownership çš„è®¾è®¡æ€æƒ³ï¼Œåœ¨æ²¡æœ‰åƒåœ¾å›æ”¶çš„åŸºç¡€ä¹‹ä¸Šï¼Œé¿å…å†…å­˜é”™è¯¯ã€‚

## å°ç»“

Rust çš„ç¡®æ˜¯ä¸€é—¨ç¥å¥‡çš„è¯­è¨€ï¼Œä¸ä»…æ‹¥æœ‰ Cã€C++ ç­‰ç³»ç»Ÿçº§åˆ«è¯­è¨€çš„é«˜æ•ˆè¿…é€Ÿï¼Œè¿˜åˆ©ç”¨ Ownership çš„è®¾è®¡æ€æƒ³ä¿è¯äº†å†…å­˜å®‰å…¨ã€‚ä¸Šé¢ä»…ä»…æ˜¯ Rust è¯­è¨€ä¸­ä¸€ä¸ªå°å°çš„ç‹¬ç‰¹ä¹‹å¤„ï¼Œç”±äºè¿™ä¸€ç‰¹æ€§æ‰€ä¿è¯çš„åŠŸèƒ½æˆ‘åœ¨å…¶ä»–è¯­è¨€ä¸­ä¹Ÿæœ‰è¿‡ç±»ä¼¼çš„ä½“éªŒï¼ˆæ¯”å¦‚ Python çš„ deep copy ä¸ shallow copy[^5]ï¼‰ï¼Œå› æ­¤æ‹¿æ¥å’Œå¤§å®¶åˆ†äº«ã€‚Rust è¿˜æœ‰æ›´å¤šæœ‰è¶£çš„è®¾è®¡ä¸å†…å®¹ç­‰å¾…å¤§å®¶å‘æ˜ã€‚æ„Ÿè°¢é˜…è¯»ã€‚

[^1]: [What is Rust and why is it so popular? - Stack Overflow Blog](https://stackoverflow.blog/2020/01/20/what-is-rust-and-why-is-it-so-popular/)
[^2]: [What do Rust's buzzwords like "safe" and "zero-cost abstraction" mean?](https://www.reddit.com/r/rust/comments/5lg3ih/what_do_rusts_buzzwords_like_safe_and_zerocost/)
[^3]: [Ownership in Rust, Part 1 - Medium](https://medium.com/@thomascountz/ownership-in-rust-part-1-112036b1126b)
[^4]: [The Rust Programming Language - Understanding Ownership](https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html)
[^5]: [copy in Python (Deep Copy and Shallow Copy) - GeeksforGeeks](https://www.geeksforgeeks.org/copy-python-deep-copy-shallow-copy/)
